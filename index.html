<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Life Collection</title>
  <meta name="author" content="Susitna">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://susitna.github.io/">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Life Collection" type="application/atom+xml">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://susitna.github.io/">
  <meta property="og:title" content="Life Collection">
  

  <script src="/javascripts/libs/jquery/jquery-2.1.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">

<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">


  
  <link href="/stylesheets/screen.css" media="screen, projection, print" rel="stylesheet" type="text/css">

  

</head>

  <body   >
    <a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>
    <div id="wrap">
      
      <div id="banner-image">
        <div class="layer">
          <div id="banner-text">
            <h1 class="page-title">Life Collection</h1>
            <p class="page-desc">
              System Engineer @ Cisco System. Loves Programming,SDN,Container...<br>
            </p>
            <br>
            <br>
            <div class="page-links center">
              <ul class="index-nav">
                  <li ><a href="#">Projects</a></li>
<li ><a href="/blog/archives">Archives</a></li>
<li ><a href="#">About</a></li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      
      <div id="main" role="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content">
    <div class="blog-index" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="Life Collection" />
    
    <meta itemprop="url" content="http://susitna.github.io" />
      
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2017-04-07T23:17:29+08:00"  data-updated="true" itemprop="datePublished dateCreated">ordinal</time>
        
      </p>
    
    
      <h2 class="entry-title" itemprop="name headline"><a href="/blog/2017/04/07/contiv-aci-mode-for-k8s-pre-configuration-and-install/" itemprop="url">Contiv(ACI-mode) for K8S_ Pre-configuration and Install</a></h2>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>Will make the reading be nice sooooooooon!</p>

<p>Hardware:
ALL servers is UCS-C
THREE servers: One for Contiv and K8S master, two for k8s nodes
One internet link for each server, same link for control and management interface.
Each node has a data link , connects  to MultiPOD ACI two pods respectively, link name is “data” in Linux OS</p>

<p>Software:
CentOS: CentOS-7-x86_64-Everything-1611.iso
             kernelversion=3.10.0-514.10.2.el7.x86_64, operatingsystem=CentOS Linux 7 (Core)
Docker: install from: <a href="http://yum.kubernetes.io/repos/kubernetes-el7-x86_64">http://yum.kubernetes.io/repos/kubernetes-el7-x86_64</a>
         Client/Server: 1.12.6, Package version: docker-common-1.12.6-11.el7.centos.x86_64
K8S :
[root@master ~]# kubectl version
Client Version: version.Info{Major:&ldquo;1&rdquo;, Minor:&ldquo;5&rdquo;, GitVersion:&ldquo;v1.5.4&rdquo;, GitCommit:&ldquo;7243c69eb523aa4377bce883e7c0dd76b84709a1&rdquo;, GitTreeState:&ldquo;clean&rdquo;, BuildDate:&ldquo;2017-03-07T23:53:09Z&rdquo;, GoVersion:&ldquo;go1.7.4&rdquo;, Compiler:&ldquo;gc&rdquo;, Platform:&ldquo;linux/amd64&rdquo;}
Server Version: version.Info{Major:&ldquo;1&rdquo;, Minor:&ldquo;4&rdquo;, GitVersion:&ldquo;v1.4.7&rdquo;, GitCommit:&ldquo;92b4f971662de9d8770f8dcd2ee01ec226a6f6c0&rdquo;, GitTreeState:&ldquo;clean&rdquo;, BuildDate:&ldquo;2016-12-10T04:43:42Z&rdquo;, GoVersion:&ldquo;go1.6.3&rdquo;, Compiler:&ldquo;gc&rdquo;, Platform:&ldquo;linux/amd64&rdquo;}
Contiv:  contiv-full-1.0.0-beta.3 , <a href="https://github.com/contiv/install/releases/download/1.0.0-beta.3/contiv-full-1.0.0-beta.3.tgz">https://github.com/contiv/install/releases/download/1.0.0-beta.3/contiv-full-1.0.0-beta.3.tgz</a>
ACI: multi-POD,2.2(1n) </p>

<p>Topology:
<img src="https://github.com/Susitna/susitna.github.io/blob/master/images/k8s-topology.png" alt="avatar" /></p>

<p>Pre-configuration:
All based on the LAB environment
0. install CentOS 7 for each server  :-)
1. Control/mgmt/internet service port is the same phy interface on the three servers,you can using proxy for internet access
2. All access and installation is based on the “root” user
3. On each of the three Servers:
3.1) vi /etc/hosts, includes the three servers, for example on Node1:
    127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4
    node1-control-ip node1 node1.localdomain
    master-control-ip master
    node2-control-ip node2
    Confirm the /etc/hostname is the same:
    [root@node1 ~]# more /etc/hostname
    node1.localdomain
3.2) disable the firewalld and SElinux:
    systemctl disable firewalls
    vi /etc/selinux/config   make this one: “SELINUX = disabled”
3.3) vi  /etc/sysconfig/network-scripts/ifcfg-(interface-name)
    configure the ONBOOT=yes
    make sure the control ip is configured and works
3.4) change docker data interface name on node1,node2, for example, change the ten1 on node1 and gig2 on node2 to “data”,
    its prerequisite for this version of Contiv, you may search google how-to.
3.5) if Contiv ACI mode, no ip needed on data interface
3.6) vi /root/.bashrc , for my environment, there’s no need of proxy to outside:
    printf -v lan &lsquo;%s,&rsquo; “master-control-ip,node1-control-ip,node2-control-ip"
    printf -v service &lsquo;%s,&rsquo; 10.254.0.{2..253}         //this is the k8s internal cluster/service ip (kubeadm init will use it)
    printf -v pool &lsquo;%s,&rsquo; 192.168.188.{1..253}               //Container ip, there gateway will be ACI BD Subnet(I use 192.168.188.1/24 as gw)
    export no_proxy=&ldquo;cisco.com,${lan%,},${service%,},${pool%,},127.0.0.1&rdquo;;
    export NO_PROXY=$no_proxy
3.7) Someone said you should install the following packages, but i didnt:
    yum -y install bzip2
    easy_install pip
    pip install netaddr
    yum -y  install python2-crypto.x86_64
    yum -y install python2-paramiko
3.8) if using Contiv ACI mode, install lldp is suggested on work node:
    cd /etc/yum.repos.d/
    wget <a href="http://download.opensuse.org/repositories/home:vbernat/RHEL_7/home:vbernat.repo">http://download.opensuse.org/repositories/home:vbernat/RHEL_7/home:vbernat.repo</a>
    yum -y install lldpd
    systemctl enable lldpd
    systemctl start lldpd
    lldpcli show neighbor    //see the neighbor of ACI Leaf from data interface
4. reboot theses servers</p>

<p>Install Kubelet/kubeadm
reference:
<a href="https://github.com/contiv/install">https://github.com/contiv/install</a>
<a href="https://kubernetes.io/docs/getting-started-guides/kubeadm/">https://kubernetes.io/docs/getting-started-guides/kubeadm/</a>
But I let the node join action at the last step, not as the reference
1. On master/node1/node2:
    #vi /etc/yum.repos.d/kubernetes.repo
        [kubernetes]
        name=Kubernetes
        baseurl=<a href="http://yum.kubernetes.io/repos/kubernetes-el7-x86_64">http://yum.kubernetes.io/repos/kubernetes-el7-x86_64</a>
        enabled=1
        gpgcheck=1
        repo_gpgcheck=1
        gpgkey=<a href="https://packages.cloud.google.com/yum/doc/yum-key.gpg">https://packages.cloud.google.com/yum/doc/yum-key.gpg</a>
            <a href="https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg">https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</a>
    #yum install -y docker kubelet kubeadm kubectl kubernetes-cni
    #systemctl enable docker &amp;&amp; systemctl start docker
    #systemctl enable kubelet &amp;&amp; systemctl start kubelet</p>

<ol>
<li><p>initializing the master on master node:
 #kubeadm init &ndash;api-advertise-addresses=<K8s-Master-IP> &ndash;skip-preflight-checks=true &ndash;use-kubernetes-version v1.4.7 &ndash;service-cidr 10.254.0.0/16     //calm down and waiting :-)
 Contiv suggests using cidr 10.254.0.0/16, its the K8S cluster internal ip, service ip
 if completed the initial, copy and backup this one:
     kubeadm join &ndash;token=the-token-key  master-ip</p></li>
<li><p>intall Contiv from master node:
 [root@master ~]# curl -L -O <a href="https://github.com/contiv/install/releases/download/1.0.0-beta.3/contiv-full-1.0.0-beta.3.tgz">https://github.com/contiv/install/releases/download/1.0.0-beta.3/contiv-full-1.0.0-beta.3.tgz</a>
 [root@master ~]# tar xf contiv-full-1.0.0-beta.3.tgz
 [root@master ~]# cd contiv-1.0.0-beta.3/install/k8s/
 [root@master k8s]# pwd
     /root/contiv-1.0.0-beta.3/install/k8s
 [root@master k8s]# ls
 aci_gw.yaml  auth_proxy.yaml  contiv_config.yaml  contiv.yaml  contiv.yaml.backup  etcd.yaml  install.sh  uninstall.sh
 [root@master k8s]# vi contiv.yaml
 change the image to use this for my LAB, you can confirm from the community:
 image: contiv/netplugin:1.0.0-beta.3-03-08-2017.18-51-20.UTC    //there are two place need modify in the yaml file
 [root@master contiv-1.0.0-beta.3]# pwd
 /root/contiv-1.0.0-beta.3
 [root@master contiv-1.0.0-beta.3]# ./install/k8s/install.sh -n  master-ip  -a <a href="https://APIC-ip:443">https://APIC-ip:443</a>  -u  APIC-username  -p APIC-pwd  phy-domain-name-of-ACI  -e not_specified  -m no     // i didnt binding ACI Leaf switch here as suggestion, will bind the Leaf from Contiv GUI.
 calm down and waiting :-)
 for this version of Contiv, will delete the kube-dns, this will modified by next Contiv Verion.
 This time you can open another ssh terminal to monitoring the k8s pods status:
 [root@master ~]#watch kubectl get pods &ndash;all-namespaces -o wide</p></li>
<li><p>Join the node1/2 to master:
 on node1/2:
 #kubeadm join &ndash;token=the-token-key  master-ip
 keep watching on master to get the nodes ready:
 [root@master ~]#watch kubectl get nodes</p></li>
</ol>


<p>So far, the installation is completed.</p>
</div>
  
  


        </article>
      
    </div>

    <ul class="pager">
      
        <li class="previous disabled"><a href="#">&larr;&nbsp;Older</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
        <li class="next disabled"><a href="#">Newer&nbsp;&rarr;</a></li>
      
    </ul>
  </div>
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2017 - Susitna<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/bhrigu123/abacus">abacus theme</a></span>.
  </small>
</p>

</div>
</footer>
    







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr.js"></script>


  </body>
</html>
